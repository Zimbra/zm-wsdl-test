<project name="ZimbraSoap" default="jar">

  <!-- Properties -->

  <property name="javac.target" value="1.6"/>
  <property name="jar.file" value="zimbrasoap.jar" />
  <property name="src.java.dir" location="src/java" />
  <property name="build.dir" location="build" />
  <property name="build.classes.dir" location="${build.dir}/classes" />
  <property name="test.dir" location="${build.dir}/test"/>
  <property name="test.src.dir" location="src/java-test"/>
  <property name="test.classes.dir" location="${build.dir}/test-classes"/>

  <property name="wsdl.test.dir" location="${build.dir}/wsdl-test"/>
  <property name="wsdl.test.src.dir" location="src/wsdl-test"/>
  <property name="wsdl.test.classes.dir" location="${build.dir}/wsdl-test-classes"/>

  <property name="common.dir" location="../ZimbraCommon"/>
  <property name="common.classes.dir" location="${common.dir}/build/classes"/>
  <property name="common.jarfile" location="${common.dir}/build/zimbracommon.jar"/>
  <property name="common.jars.dir" location="${common.dir}/jars"/>
  <property name="metro.jars.dir" location="jars/metro"/>

  <property name="xml.schema.dir" location="${build.dir}/schema"/>

  <property name="TESTNAME" value="com.zimbra.soap.admin.GetServerTest" />
  <property name="WSDLTEST" value="com.zimbra.soap.account.WSDLAuthRequestTest" />

  <path id="all.java.path">
    <pathelement location="${src.java.dir}" />
  </path>

  <path id="class.path">
    <pathelement location="${common.classes.dir}"/>
    <pathelement location="${build.classes.dir}" />
    <fileset dir="${common.jars.dir}">
        <include name="**/*.jar"/>
    </fileset>
  </path>

  <path id="jaxws.classpath">
    <fileset dir="${metro.jars.dir}">
        <include name="**/*.jar"/>
    </fileset>
  </path>

  <path id="test.class.path">
    <path refid="class.path"/>
  </path>

  <!-- WSDL client side tests should be Zimbra code independant -->
  <path id="wsdl.test.class.path">
    <path refid="jaxws.classpath"/>
    <pathelement location="${build.classes.dir}" />
    <fileset dir="${common.jars.dir}">
        <include name="**/junit*.jar"/>
        <include name="**/guava*.jar"/>
        <include name="**/log4j*.jar"/>
    </fileset>
  </path>

  <taskdef name="schemagen" classname="com.sun.tools.jxc.SchemaGenTask">
    <classpath refid="jaxws.classpath"/>
  </taskdef>

  <taskdef name="wsimport" classname="com.sun.tools.ws.ant.WsImport">
      <classpath refid="jaxws.classpath"/>
  </taskdef>

  <!-- Targets -->
  <target name="build-init">
    <mkdir dir="${build.classes.dir}" />
  </target>

  <target name="compile" depends="build-init" description="Compiles the source code">
    <ant dir="${common.dir}" target="jar" inheritAll="false"/>
    <javac destdir="${build.classes.dir}" debug="true" classpathref="class.path" target="${javac.target}">
      <src refid="all.java.path" />
    </javac>
  </target>

  <target name="jar" depends="compile" description="Creates the jar file">
    <jar destfile="${build.dir}/${jar.file}" basedir="${build.classes.dir}" />
  </target>

  <target name="clean" description="Removes build files">
    <delete dir="${build.dir}" />
  </target>

  <target name="wsdl-files" depends="compile">
    <mkdir dir="${xml.schema.dir}"/>
    <java classname="com.zimbra.soap.util.WsdlGenerator" classpathref="class.path" fork="true" failonerror="true">
            <arg line="-output.dir ${xml.schema.dir}"/>
    </java>
  </target>

  <target name="generate-schema">
    <mkdir dir="${xml.schema.dir}"/>
    <schemagen srcdir="${src.java.dir}" destdir="${xml.schema.dir}">
      <classpath refid="class.path"/>
      <schema namespace="urn:zimbra" file="zimbra.xsd" />
      <schema namespace="urn:zimbraAccount" file="zimbraAccount.xsd" />
      <schema namespace="urn:zimbraAdmin" file="zimbraAdmin.xsd" />
      <schema namespace="urn:zimbraMail" file="zimbraMail.xsd" />
    </schemagen>
  </target>

  <target name="account-service-client-support" depends="wsdl-files,generate-schema">
    <mkdir dir="${wsdl.test.classes.dir}"/>
    <delete dir="${wsdl.test.src.dir}/com/zimbra/soap/account/wsimport/generated" />
    <!-- extension="true|false" - allow vendor extensions -->
    <wsimport   wsdl="${xml.schema.dir}/AccountService.wsdl"
                destdir="${wsdl.test.classes.dir}"
                sourcedestdir="${wsdl.test.src.dir}"
                keep="false"
                package="com.zimbra.soap.account.wsimport.generated">
    </wsimport>
    <!-- Bug 58024 java.util.logging implicated in changing process default charset. -->
    <replace file="${wsdl.test.src.dir}/com/zimbra/soap/account/wsimport/generated/AccountService_Service.java">
        <replacefilter token="java.util.logging.Logger"
                       value="org.apache.log4j.Logger"/>
        <replacefilter token="logger.warning"
                       value="logger.warn"/>
    </replace>
    <!-- force re-compile with modified source. -->
    <delete file="${wsdl.test.classes.dir}/com/zimbra/soap/account/wsimport/generated/AccountService_Service.class"/>
  </target>

  <target name="admin-service-client-support" depends="wsdl-files,generate-schema">
    <mkdir dir="${wsdl.test.classes.dir}"/>
    <delete dir="${wsdl.test.src.dir}/com/zimbra/soap/admin/wsimport/generated" />
    <!-- extension="true|false" - allow vendor extensions -->
    <wsimport   wsdl="${xml.schema.dir}/AdminService.wsdl"
                destdir="${wsdl.test.classes.dir}"
                sourcedestdir="${wsdl.test.src.dir}"
                keep="false"
                package="com.zimbra.soap.admin.wsimport.generated">
    </wsimport>
    <!-- Bug 58024 java.util.logging implicated in changing process default charset. -->
    <replace file="${wsdl.test.src.dir}/com/zimbra/soap/admin/wsimport/generated/AdminService_Service.java">
        <replacefilter token="java.util.logging.Logger"
                       value="org.apache.log4j.Logger"/>
        <replacefilter token="logger.warning"
                       value="logger.warn"/>
    </replace>
    <!-- force re-compile with modified source. -->
    <delete file="${wsdl.test.classes.dir}/com/zimbra/soap/admin/wsimport/generated/AdminService_Service.class"/>
  </target>

  <target name="mail-service-client-support" depends="wsdl-files,generate-schema">
    <mkdir dir="${wsdl.test.classes.dir}"/>
    <delete dir="${wsdl.test.src.dir}/com/zimbra/soap/mail/wsimport/generated" />
    <!-- extension="true|false" - allow vendor extensions -->
    <wsimport   wsdl="${xml.schema.dir}/MailService.wsdl"
                destdir="${wsdl.test.classes.dir}"
                sourcedestdir="${wsdl.test.src.dir}"
                keep="false"
                package="com.zimbra.soap.mail.wsimport.generated">
    </wsimport>
    <!-- Bug 58024 java.util.logging implicated in changing process default charset. -->
    <replace file="${wsdl.test.src.dir}/com/zimbra/soap/mail/wsimport/generated/MailService_Service.java">
        <replacefilter token="java.util.logging.Logger"
                       value="org.apache.log4j.Logger"/>
        <replacefilter token="logger.warning"
                       value="logger.warn"/>
    </replace>
    <!-- force re-compile with modified source. -->
    <delete file="${wsdl.test.classes.dir}/com/zimbra/soap/mail/wsimport/generated/MailService_Service.class"/>
  </target>

  <target name="wsdl-client-support"
      depends="account-service-client-support,admin-service-client-support,mail-service-client-support">
  </target>

  <target name="wsdl-test-compile" depends="compile,wsdl-client-support">
    <mkdir dir="${wsdl.test.classes.dir}"/>
    <javac srcdir="${wsdl.test.src.dir}" destdir="${wsdl.test.classes.dir}"
      debug="true" classpathref="wsdl.test.class.path" target="${javac.target}"/>
    <copy todir="${wsdl.test.classes.dir}">
      <fileset dir="${wsdl.test.src.dir}" excludes="**/*.java"/>
    </copy>
  </target>

  <!-- WSDL client tests that require ZimbraServer installed and some setup in place -->
  <target name="wsdl-test" depends="wsdl-test-compile" description="Run unit tests">
    <delete dir="${wsdl.test.dir}" quiet="true"/>
    <mkdir dir="${wsdl.test.dir}/output"/>
    <mkdir dir="${wsdl.test.dir}/report"/>
    <junit printsummary="on" haltonfailure="on" tempdir="${wsdl.test.dir}">
      <classpath refid="wsdl.test.class.path"/>
      <classpath path="${wsdl.test.classes.dir}"/>
      <formatter type="xml"/>
      <batchtest todir="${wsdl.test.dir}/output">
        <fileset dir="${wsdl.test.src.dir}">
          <include name="**/*Test.java"/>
        </fileset>
      </batchtest>
    </junit>
    <junitreport todir="${wsdl.test.dir}/report">
      <fileset dir="${wsdl.test.dir}/output"/>
      <report todir="${wsdl.test.dir}/report"/>
    </junitreport>
    <echo>WSDL Test Report: ${wsdl.test.dir}/report/index.html</echo>
  </target>

  <!-- e.g. ant -DWSDLTEST=com.zimbra.soap.account.WSDLAuthRequestTest one-wsdl-test -->
  <target name="one-wsdl-test" depends="wsdl-test-compile" description="Run a single unit test">
    <delete dir="${wsdl.test.dir}-one" quiet="true"/>
    <mkdir dir="${wsdl.test.dir}-one/output"/>
    <junit printsummary="on" failureproperty="junit.failure" tempdir="${wsdl.test.dir}-one">
      <classpath refid="wsdl.test.class.path"/>
      <classpath path="${wsdl.test.classes.dir}"/>
      <assertions><enable/></assertions>
      <formatter type="xml"/>
      <test name="${WSDLTEST}" todir="${wsdl.test.dir}-one/output" />
    </junit>
    <fail if="junit.failure" message="Unit test failed"/>
  </target>

  <target name="test-compile" depends="compile">
    <mkdir dir="${test.classes.dir}"/>
    <javac srcdir="${test.src.dir}" destdir="${test.classes.dir}"
      debug="true" classpathref="test.class.path" target="${javac.target}"/>
    <copy todir="${test.classes.dir}">
      <fileset dir="${test.src.dir}" excludes="**/*.java"/>
    </copy>
  </target>

  <!-- tests that do not require ZimbraServer installed -->
  <target name="test" depends="test-compile" description="Run unit tests">
    <delete dir="${test.dir}" quiet="true"/>
    <mkdir dir="${test.dir}/output"/>
    <mkdir dir="${test.dir}/report"/>
    <junit printsummary="on" failureproperty="junit.failure" tempdir="${test.dir}">
      <classpath refid="test.class.path"/>
      <classpath path="${test.classes.dir}"/>
      <assertions><enable/></assertions>
      <formatter type="xml"/>
      <batchtest todir="${test.dir}/output">
        <fileset dir="${test.src.dir}">
          <include name="**/*Test.java"/>
        </fileset>
      </batchtest>
    </junit>
    <junitreport todir="${test.dir}/report">
      <fileset dir="${test.dir}/output"/>
      <report todir="${test.dir}/report"/>
    </junitreport>
    <echo>Test Report: ${test.dir}/report/index.html</echo>
    <fail if="junit.failure" message="Unit test failed"/>
  </target>

  <!-- e.g. ant -DTESTNAME=com.zimbra.soap.admin.GetServerTest one-test -->
  <target name="one-test" depends="test-compile" description="Run unit tests">
    <delete dir="${test.dir}-one" quiet="true"/>
    <mkdir dir="${test.dir}-one/output"/>
    <junit printsummary="on" failureproperty="junit.failure" tempdir="${test.dir}-one">
      <classpath refid="test.class.path"/>
      <classpath path="${test.classes.dir}"/>
      <assertions><enable/></assertions>
      <formatter type="xml"/>
      <test name="${TESTNAME}" todir="${test.dir}-one/output" />
    </junit>
    <fail if="junit.failure" message="Unit test failed"/>
  </target>

</project>
